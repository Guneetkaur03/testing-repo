name: Create Review Issue on Close

on:
  issues:
    types: [closed]

jobs:
  create_review_issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    env:
      GH_TOKEN: ${{ secrets.PROJECT_PAT }}
      # Use inputs.project-url if available (for workflow_call), else fallback to hardcoded value
      PROJECT_URL: ${{ inputs.project-url || 'https://github.com/users/Guneetkaur03/projects/2' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse trigger issue
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          TITLE="${{ github.event.issue.title }}"

          OPEN_REVIEW=$(echo "$BODY" | grep -i "Open Review Issue:" | grep -oEi "true|false" | head -n1)
          ASSIGNEE=$(echo "$BODY" | grep -i "Assign To:" | sed -E 's/.*Assign To:\s*//i' | sed 's/@//g' | xargs)

          echo "open_review=${OPEN_REVIEW,,}" >> $GITHUB_OUTPUT
          echo "assignee=$ASSIGNEE" >> $GITHUB_OUTPUT

      - name: Check if review issue already exists
        id: exists
        run: |
          result=$(gh issue list --search "Review Issue ${{ github.event.issue.number }} in:title" --json number,title --jq ".[] | select(.title == \"Review Issue ${{ github.event.issue.number }}\")")
          if [[ -n "$result" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}


      - name: Create review issue
        if: steps.parse.outputs.open_review == 'true' && steps.exists.outputs.exists == 'false'
        id: new_issue
        uses: actions/github-script@v6
        with:
          script: |
            const original = context.payload.issue;
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Review Issue ${original.number}`,
              body: `Auto-generated review issue for [#${original.number}](${original.html_url})`,
              assignees: ['${{ steps.parse.outputs.assignee }}'],
              labels: ['review']
            });
            core.setOutput("issue_number", newIssue.data.number);
            core.setOutput("node_id", newIssue.data.node_id);

      - name: Add to Pontem Scheduling project and set status to Ready
        if: steps.new_issue.outputs.node_id
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_ID: ${{ steps.new_issue.outputs.node_id }}
          PROJECT_URL: ${{ env.PROJECT_URL }}
        run: |
          set -euo pipefail

          url="$PROJECT_URL"
          org=$(echo "$url" | awk -F'orgs/' '{print $2}' | cut -d/ -f1)
          num=$(echo "$url" | awk -F'projects/' '{print $2}' | cut -d/ -f1)

          proj_node=$(gh api graphql -f query='
            query($org:String!){
              organization(login:$org){
                projectsV2(first:100){ nodes{ number id } }
              }
            }' -f org="$org" \
            --jq '.data.organization.projectsV2.nodes[]
                  | select(.number=='"$num"')
                  | .id')

          item=$(gh api graphql -f query='
            query($proj:ID!){
              node(id:$proj){
                ... on ProjectV2{
                  items(first:100){
                    nodes{
                      id
                      content{ ... on Issue{ id } }
                    }
                  }
                }
              }
            }' -f proj="$proj_node" \
            --jq '.data.node.items.nodes[]
                  | select(.content.id=="'$ISSUE_ID'")
                  | .id')

          if [[ -z "$item" || "$item" == "null" ]]; then
            item=$(gh api graphql -f query='
              mutation($proj:ID!,$issue:ID!){
                addProjectV2ItemById(input:{projectId:$proj,contentId:$issue}){
                  item{ id }
                }
              }' -f proj="$proj_node" -f issue="$ISSUE_ID" \
              --jq '.data.addProjectV2ItemById.item.id')
          fi

          # Set Status = Ready
          field_id=$(gh api graphql -f query='
            query($proj:ID!){
              node(id:$proj){
                ... on ProjectV2{
                  fields(first:50){ nodes {
                    id
                    name
                    ... on ProjectV2SingleSelectField { options { id name } }
                  }}
                }
              }
            }' -f proj="$proj_node" \
            --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')

          ready_option=$(gh api graphql -f query='
            query($proj:ID!){
              node(id:$proj){
                ... on ProjectV2{
                  fields(first:50){ nodes {
                    name
                    ... on ProjectV2SingleSelectField { options { id name } }
                  }}
                }
              }
            }' -f proj="$proj_node" \
            --jq '.data.node.fields.nodes[]
                  | select(.name=="Status")
                  | .options[] | select(.name=="Ready") | .id')

          gh api graphql -f query='
            mutation($proj:ID!,$item:ID!,$field:ID!,$option:ID!){
              updateProjectV2ItemFieldValue(input:{
                projectId:$proj,
                itemId:$item,
                fieldId:$field,
                value:{singleSelectOptionId:$option}
              }) {
                projectV2Item { id }
              }
            }' \
            -f proj="$proj_node" -f item="$item" -f field="$field_id" -f option="$ready_option"

          echo "âœ… Review issue added and marked Ready"
